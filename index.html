<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart AgriTech Dashboard</title>
    <!-- Favicon: A simple SVG icon for the browser tab -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2368D391'%3E%3Cpath d='M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z'/%3E%3Cpath d='M11 15h2v2h-2zm0-8h2v6h-2z' fill='%232D3748'/%3E%3C/svg%3E" type="image/svg+xml">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Plotly.js CDN for charts -->
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Base styles for body and font */
        body {
            font-family: 'Inter', sans-serif;
            /* More attractive radial gradient background */
            background: radial-gradient(circle at top left, #2a3447, #1a202c 70%);
            color: #e2e8f0; /* Light text */
            min-height: 100vh; /* Ensure full viewport height */
            display: flex;
            flex-direction: column;
            overflow-x: hidden; /* Prevent horizontal scroll on animations */
        }

        /* Main container for content */
        .container {
            max-width: 1400px; /* Increased max-width for more content */
            margin: 0 auto;
            padding: 1.5rem; /* Slightly reduced padding for smaller screens */
            flex-grow: 1; /* Allow container to grow */
            animation: fadeIn 1s ease-out forwards; /* Fade-in animation for the whole container */
            opacity: 0; /* Start invisible for animation */
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .container {
                padding: 2rem; /* Restore original padding on larger screens */
            }
        }

        /* Card styling */
        .card {
            background-color: #2d3748; /* Darker card background */
            border-radius: 1.5rem; /* rounded-3xl for more pronounced corners */
            padding: 1.5rem;
            /* Enhanced multi-layered shadow for depth */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3), 0 5px 10px rgba(0, 0, 0, 0.2);
            border: 1px solid #4a5568; /* Subtle border */
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; /* Smooth hover effect */
            position: relative; /* For potential pseudo-elements or overlays */
            overflow: hidden; /* Ensure content stays within rounded corners */
        }

        .card:hover {
            transform: translateY(-8px) scale(1.01); /* Lift card more and slightly scale */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 8px 15px rgba(0, 0, 0, 0.3); /* Stronger shadow on hover */
        }

        /* Button styling enhancements */
        .button-primary {
            background: linear-gradient(45deg, #48bb78, #38a169); /* Green gradient */
            border: none;
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .button-primary:hover {
            background: linear-gradient(45deg, #38a169, #2f855a); /* Darker green on hover */
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .button-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Secondary button for play alerts */
        .button-secondary {
            background: linear-gradient(45deg, #63b3ed, #4299e1); /* Blue gradient */
            border: none;
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .button-secondary:hover {
            background: linear-gradient(45deg, #4299e1, #3182ce); /* Darker blue on hover */
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .button-secondary:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Fade-in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom scrollbar for raw data table */
        .dataframe-container {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 0.75rem; /* rounded-xl */
            background-color: #2d3748;
            border: 1px solid #4a5568;
        }

        /* Table styling within dataframe-container */
        .dataframe-container table {
            width: 100%;
            border-collapse: collapse;
        }

        .dataframe-container th, .dataframe-container td {
            padding: 0.75rem 1rem; /* Increased padding */
            border-bottom: 1px solid #4a5568;
            text-align: left;
        }

        .dataframe-container th {
            background-color: #4a5568;
            font-weight: bold;
            color: #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 1;
            text-transform: uppercase; /* Uppercase headers */
            letter-spacing: 0.05em; /* Slight letter spacing */
        }

        .dataframe-container tr:nth-child(even) {
            background-color: #2d3748; /* Alternate row background */
        }
        .dataframe-container tr:nth-child(odd) {
            background-color: #242c38; /* Alternate row background */
        }
        .dataframe-container tr:hover {
            background-color: #4a5568; /* Darker on hover */
        }

        /* Loading spinner animation */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Styling for Google Translate dropdown - Improved UI */
        #google_translate_element {
            /* Hide Google Translate's default branding */
            display: inline-block; /* Keep it block to allow styling */
            vertical-align: middle;
        }

        /* Hide the Google Translate banner/toolbar */
        .goog-te-banner-frame.skiptranslate {
            display: none !important;
        }
        body {
            top: 0px !important; /* Remove the top margin added by Google Translate */
        }

        /* Style the Google Translate dropdown itself */
        #google_translate_element .goog-te-gadget-simple {
            background-color: #2d3748 !important; /* Card background */
            border: 1px solid #4a5568 !important; /* Subtle border */
            border-radius: 0.75rem !important; /* rounded-xl */
            padding: 0.5rem 0.75rem !important;
            color: #e2e8f0 !important; /* Light text */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease-in-out;
            font-size: 1rem;
            line-height: 1.5; /* Ensure text aligns well */
            height: auto; /* Allow height to adjust */
            overflow: hidden; /* Prevent text overflow */
            display: flex; /* Use flex to align content */
            align-items: center; /* Vertically center content */
            justify-content: space-between; /* Space between text and arrow */
            cursor: pointer;
        }

        #google_translate_element .goog-te-gadget-simple:hover {
            border-color: #68D391 !important; /* Highlight border on hover */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        #google_translate_element .goog-te-gadget-simple .goog-te-menu-value {
            color: #e2e8f0 !important;
            font-weight: 500;
            flex-grow: 1; /* Allow text to take available space */
            white-space: nowrap; /* Prevent wrapping */
            overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
        }
        #google_translate_element .goog-te-gadget-simple .goog-te-menu-value span {
            color: #e2e8f0 !important;
        }
        #google_translate_element .goog-te-gadget-simple .goog-te-menu-value span:hover {
            color: #cbd5e0 !important; /* Lighter on hover */
        }

        /* Custom arrow for the dropdown */
        #google_translate_element .goog-te-gadget-simple .goog-te-menu-value img {
            display: none !important; /* Hide default Google arrow image */
        }
        #google_translate_element .goog-te-gadget-simple .goog-te-menu-value::after {
            content: '\f078'; /* Font Awesome chevron-down icon */
            font-family: 'Font Awesome 6 Free'; /* Use Font Awesome */
            font-weight: 900; /* Solid icon */
            margin-left: 0.5rem;
            color: #cbd5e0; /* Icon color */
            font-size: 0.8rem;
        }


        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 90px; /* Increased width */
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4a5568; /* Darker grey when off */
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: #e2e8f0; /* Light grey knob */
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        input:checked + .slider {
            background-color: #48bb78; /* Green when checked */
            box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #48bb78;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(56px); /* Adjusted for wider switch */
            -ms-transform: translateX(56px);
            transform: translateX(56px);
        }

        /* Round sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* Labels for toggle switch */
        .toggle-labels {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            padding: 0 10px; /* Adjusted padding */
            color: #cbd5e0; /* Lighter text for labels */
            font-weight: bold;
            font-size: 0.8rem;
            pointer-events: none; /* Make labels unclickable */
        }
        .toggle-labels span {
            pointer-events: none; /* Make labels unclickable */
        }

        /* Custom select box styling */
        select {
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%23A0AEC0' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em;
            padding-right: 2.5rem; /* Space for the custom arrow */
        }

        /* Circular Progress Bar Styling */
        .circular-progress-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            text-align: center;
            position: relative;
            background-color: #242c38; /* Slightly darker background for each sensor item */
            border-radius: 1rem;
            border: 1px solid #3a4458;
            height: 100%; /* Ensure consistent height within the grid */
        }

        .circular-progress {
            position: relative;
            width: 80px; /* Smaller size for the circle */
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            background: conic-gradient(#48bb78 0%, #38a169 0%); /* Default to 0% */
            transition: background 0.5s ease-in-out;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.3);
        }

        .circular-progress::before {
            content: '';
            position: absolute;
            width: 65px; /* Inner circle size */
            height: 65px;
            border-radius: 50%;
            background-color: #2d3748; /* Card background color */
            z-index: 1;
        }

        .progress-value {
            position: relative;
            font-size: 1.25rem; /* text-xl */
            font-weight: bold;
            color: #e2e8f0;
            z-index: 2;
        }

        .sensor-icon {
            position: relative;
            z-index: 2;
            color: #68D391; /* Green icon color */
            font-size: 1.5rem; /* Larger icon */
            margin-bottom: 0.25rem;
        }

        .sensor-label {
            font-size: 0.9rem; /* text-sm */
            color: #cbd5e0;
            margin-top: 0.25rem;
        }

        .sensor-update-time {
            font-size: 0.75rem; /* text-xs */
            color: #94a3b8;
            margin-top: 0.5rem;
        }

        /* Specific colors for different gauges */
        .circular-progress.soil-moisture { background: conic-gradient(#68D391 0%, #38a169 0%); }
        .circular-progress.temperature { background: conic-gradient(#F6AD55 0%, #DD6B20 0%); }
        .circular-progress.humidity { background: conic-gradient(#63B3ED 0%, #4299E1 0%); }
        .circular-progress.ph { background: conic-gradient(#A78BFA 0%, #805AD5 0%); }
        .circular-progress.light-intensity { background: conic-gradient(#ECC94B 0%, #D69E2E 0%); }
        .circular-progress.rainfall { background: conic-gradient(#4299E1 0%, #3182CE 0%); }

        /* Weather Card Styling */
        .weather-day {
            border-bottom: 1px solid #4a5568;
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .weather-day:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        /* Farm Health Index Progress Bar */
        .health-factor-progress {
            height: 8px;
            background-color: #4a5568;
            border-radius: 9999px; /* full rounded */
            overflow: hidden;
        }
        .health-factor-bar {
            height: 100%;
            background-color: #48bb78; /* Green */
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }

        /* Collapsible section styling */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #4a5568;
            font-weight: 600;
            color: #e2e8f0;
            transition: color 0.2s ease-in-out;
        }
        .collapsible-header:hover {
            color: #68D391;
        }
        .collapsible-content {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            display: none; /* Hidden by default */
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }
        .collapsible-content.active {
            display: block; /* Show when active */
        }
        .collapsible-header .fas {
            transition: transform 0.3s ease-in-out;
        }
        .collapsible-header.active .fas {
            transform: rotate(90deg);
        }

        /* Real-Time Plant Monitoring Styling */
        .camera-feed-placeholder {
            background-color: #1a202c;
            border: 2px solid #4a5568;
            border-radius: 1rem;
            width: 100%; /* Full width in parent container */
            max-width: 100%;
            aspect-ratio: 16 / 9;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #cbd5e0;
            font-size: clamp(0.9rem, 2vw, 1rem);
            position: relative;
            overflow: hidden;
            animation: pulse 2s infinite alternate;
        }

        /* Pulse Animation */
        @keyframes pulse {
            0% { box-shadow: 0 0 0px rgba(72, 187, 120, 0.4); }
            100% { box-shadow: 0 0 15px rgba(72, 187, 120, 0.8); }
        }

        /* Live Indicator */
        .camera-feed-placeholder .live-indicator {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background-color: #e53e3e;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: clamp(0.6rem, 1.5vw, 0.75rem);
            font-weight: bold;
            display: flex;
            align-items: center;
            animation: blink 1s infinite;
        }

        /* Blinking */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Connection Status */
        .camera-feed-placeholder .connection-status {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: #48bb78;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: clamp(0.6rem, 1.5vw, 0.75rem);
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        /* Camera Details (now external) */
        .camera-details-external {
            /* Changed from grid to flex column for single line display */
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* Space between items */
            background-color: rgba(0, 0, 0, 0.4); /* Dark semi-transparent background */
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            margin-top: 1rem; /* Space from the camera feed box */
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border: 1px solid #4a5568;
        }
        .camera-details-external span {
            background-color: rgba(0, 0, 0, 0.2); /* Slightly darker background for individual items */
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            display: block; /* Make them block to take full width */
            text-align: left; /* Align text to left */
            font-size: clamp(0.75rem, 1.5vw, 0.9rem);
            color: #cbd5e0;
            white-space: normal; /* Allow text wrapping if needed */
            overflow: visible; /* Do not hide overflow text */
            text-overflow: clip; /* Do not add ellipsis */
        }


        /* Camera Icon */
        .camera-feed-placeholder .camera-icon {
            font-size: clamp(2rem, 5vw, 3rem);
            color: #63b3ed;
            margin-bottom: 0.5rem;
        }

        /* Overlay Text */
        .camera-feed-placeholder .camera-overlay-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(1rem, 3vw, 1.5rem);
            font-weight: bold;
            color: rgba(255, 255, 255, 0.2);
            pointer-events: none;
        }

        /* Header Styling */
        .main-header {
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Align to start, as icons are removed */
            margin-bottom: 2rem;
            padding: 1rem 0;
            border-bottom: 1px solid #4a5568;
        }
        .main-header .logo-section {
            display: flex;
            align-items: center;
        }
        .main-header .logo-section img {
            height: 60px; /* Larger logo */
            margin-right: 1rem;
        }
        .main-header .title-section h1 {
            font-size: 2.5rem; /* Larger main title */
            font-weight: bold;
            color: #68D391;
            line-height: 1;
        }
        .main-header .title-section p {
            font-size: 1rem;
            color: #a0aec0;
            margin-top: 0.25rem;
        }
        /* Removed .main-header .header-icons as per request */
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container">
        <!-- Main Header -->
        <header class="main-header">
            <div class="logo-section">
                <img src="android-chrome-192x192.png" alt="AgriTech Logo" class="rounded-full">
                <div class="title-section">
                    <h1>SMART AGRITECH DASHBOARD</h1>
                    <p>Advanced AI & Sensor Technology for Modern Agriculture</p>
                </div>
            </div>
            <!-- Removed header-icons section as per request -->
        </header>

        <div class="flex flex-col sm:flex-row justify-between items-center mb-8 space-y-4 sm:space-y-0">
            <button id="refresh-button" class="button-primary w-full sm:w-auto">
                <i class="fas fa-sync-alt mr-2"></i> Refresh Data
            </button>
            <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-6 w-full sm:w-auto">
                <!-- Simulation Mode Toggle -->
                <div class="flex items-center space-x-3">
                    <span class="text-lg font-medium text-gray-300">Mode:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="simulation-mode-toggle">
                        <span class="slider round"></span>
                        <div class="toggle-labels">
                            <span class="ml-1">Real</span>
                            <span class="mr-1">Sim</span>
                        </div>
                    </label>
                </div>
                <div class="flex items-center space-x-3">
                    <label for="google_translate_element" class="text-lg font-medium text-gray-300">Choose Language:</label>
                    <!-- Google Translate Dropdown -->
                    <div id="google_translate_element" style="margin-bottom: 0;"></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8 mb-8">

            <!-- Current Sensor Readings (Top-Left, Tall) -->
            <div class="card xl:row-span-2">
                <h2 class="text-2xl font-semibold text-green-300 mb-5 border-b border-gray-700 pb-3">
                    <i class="fas fa-tachometer-alt mr-2"></i> Current Sensor Readings
                </h2>
                <!-- Custom Circular Gauges -->
                <div id="current-sensor-readings-grid" class="grid grid-cols-2 gap-4 mb-6">
                    <!-- Soil Moisture -->
                    <div class="circular-progress-container">
                        <div class="circular-progress soil-moisture" data-value="0">
                            <span class="progress-value">0%</span>
                        </div>
                        <i class="fas fa-tint sensor-icon"></i>
                        <span class="sensor-label">Soil Moisture</span>
                        <span class="sensor-update-time" id="soil-moisture-update">Updated: N/A</span>
                    </div>
                    <!-- Temperature -->
                    <div class="circular-progress-container">
                        <div class="circular-progress temperature" data-value="0">
                            <span class="progress-value">0°C</span>
                        </div>
                        <i class="fas fa-thermometer-half sensor-icon"></i>
                        <span class="sensor-label">Temperature</span>
                        <span class="sensor-update-time" id="temperature-update">Updated: N/A</span>
                    </div>
                    <!-- Humidity -->
                    <div class="circular-progress-container">
                        <div class="circular-progress humidity" data-value="0">
                            <span class="progress-value">0%</span>
                        </div>
                        <i class="fas fa-water sensor-icon"></i>
                        <span class="sensor-label">Humidity</span>
                        <span class="sensor-update-time" id="humidity-update">Updated: N/A</span>
                    </div>
                    <!-- pH Level -->
                    <div class="circular-progress-container">
                        <div class="circular-progress ph" data-value="0">
                            <span class="progress-value">0</span>
                        </div>
                        <i class="fas fa-flask sensor-icon"></i>
                        <span class="sensor-label">pH Level</span>
                        <span class="sensor-update-time" id="ph-update">Updated: N/A</span>
                    </div>
                    <!-- Light Intensity -->
                    <div class="circular-progress-container">
                        <div class="circular-progress light-intensity" data-value="0">
                            <span class="progress-value">0 lux</span>
                        </div>
                        <i class="fas fa-sun sensor-icon"></i>
                        <span class="sensor-label">Light Intensity</span>
                        <span class="sensor-update-time" id="light-intensity-update">Updated: N/A</span>
                    </div>
                    <!-- Rainfall -->
                    <div class="circular-progress-container">
                        <div class="circular-progress rainfall" data-value="0">
                            <span class="progress-value">0 mm</span>
                        </div>
                        <i class="fas fa-cloud-showers-heavy sensor-icon"></i>
                        <span class="sensor-label">Rainfall</span>
                        <span class="sensor-update-time" id="rainfall-update">Updated: N/A</span>
                    </div>
                </div>

                <!-- New: Device Connectivity -->
                <h3 class="text-xl font-medium text-gray-200 mb-3 border-t border-gray-700 pt-4"><i class="fas fa-network-wired mr-2"></i> Device Connectivity</h3>
                <div id="device-connectivity" class="space-y-3">
                    <div class="flex justify-between items-center text-gray-300">
                        <span>Main Gateway</span>
                        <span id="gateway-status" class="font-semibold text-green-400"><i class="fas fa-circle text-xs mr-1"></i> Online</span>
                    </div>
                    <div class="flex justify-between items-center text-gray-300">
                        <span>Irrigation System</span>
                        <span id="irrigation-status" class="font-semibold text-green-400"><i class="fas fa-circle text-xs mr-1"></i> Active</span>
                    </div>
                    <div class="flex justify-between items-center text-gray-300">
                        <span>Camera Units</span>
                        <span id="camera-status" class="font-semibold text-green-400"><i class="fas fa-circle text-xs mr-1"></i> 3/3 Connected</span>
                    </div>
                    <div class="flex justify-between items-center text-gray-300">
                        <span>Soil Sensors</span>
                        <span id="soil-sensor-status" class="font-semibold text-green-400"><i class="fas fa-circle text-xs mr-1"></i> All Online</span>
                    </div>
                </div>
            </div>

            <!-- Sensor Trends Over Time (Top-Middle, Wide) -->
            <div class="card xl:col-span-2">
                <h2 class="text-2xl font-semibold text-green-300 mb-5 border-b border-gray-700 pb-3">
                    <i class="fas fa-chart-line mr-2"></i> Sensor Trends Over Time
                </h2>
                <div id="sensor-trends-chart" class="w-full h-80"></div>
                <p id="sensor-trends-status" class="text-sm text-gray-400 mt-3 text-center"></p>
            </div>

            <!-- Weather Card (Top-Right, Normal) -->
            <div class="card">
                <h2 class="text-2xl font-semibold text-green-300 mb-5 border-b border-gray-700 pb-3">
                    <i class="fas fa-cloud-sun mr-2"></i> Weather
                </h2>
                <div id="weather-data" class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-cloud text-5xl text-blue-300 mr-4"></i>
                            <div>
                                <p class="text-5xl font-bold text-white" id="current-temp">24°C</p>
                                <p class="text-gray-400 text-lg" id="current-humidity">68% Humidity</p>
                            </div>
                        </div>
                        <p class="text-gray-400 text-lg"><i class="fas fa-wind mr-2"></i> <span id="wind-speed">12 km/h</span></p>
                    </div>

                    <div id="weather-forecast">
                        <div class="weather-day flex justify-between items-center">
                            <p class="text-gray-300"><i class="fas fa-calendar-day mr-2"></i> Today</p>
                            <p class="text-gray-200"><span id="today-high">26°</span> <span class="text-gray-400" id="today-low">18°</span></p>
                        </div>
                        <div class="weather-day flex justify-between items-center">
                            <p class="text-gray-300"><i class="fas fa-calendar-alt mr-2"></i> Tomorrow</p>
                            <p class="text-gray-200"><span id="tomorrow-high">23°</span> <span class="text-gray-400" id="tomorrow-low">16°</span></p>
                        </div>
                        <div class="weather-day flex justify-between items-center">
                            <p class="text-gray-300"><i class="fas fa-calendar-week mr-2"></i> Wed</p>
                            <p class="text-gray-200"><span id="wed-high">21°</span> <span class="text-gray-400" id="wed-low">14°</span></p>
                        </div>
                    </div>
                </div>

                <!-- New: Weather Advisories -->
                <h3 class="text-xl font-medium text-gray-200 mb-3 border-t border-gray-700 pt-4"><i class="fas fa-exclamation-triangle mr-2"></i> Weather Advisories</h3>
                <div id="weather-advisories" class="space-y-2 text-gray-300">
                    <p><i class="fas fa-circle-info text-blue-400 text-sm mr-2"></i> No active advisories.</p>
                    <!-- Example: <p class="text-yellow-400"><i class="fas fa-cloud-showers-heavy text-sm mr-2"></i> Heavy Rainfall expected tonight.</p> -->
                </div>
            </div>

            <!-- Crop Care & AI Insights (Middle-Left, Wide) -->
            <div class="card xl:col-span-2">
                <h2 class="text-2xl font-semibold text-green-300 mb-5 border-b border-gray-700 pb-3">
                    <i class="fas fa-seedling mr-2"></i> Crop Care & AI Insights
                </h2>

                <div class="mb-6">
                    <label for="crop-select" class="block text-lg font-medium text-gray-300 mb-2">
                        <i class="fas fa-leaf mr-2"></i> Active Crop:
                    </label>
                    <select id="crop-select" class="w-full bg-gray-700 text-white py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 border border-gray-600">
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <!-- AI Recommendations (Collapsible) -->
                <div class="mb-4">
                    <div class="collapsible-header" onclick="toggleCollapsible('ai-recommendations-content')">
                        <h3 class="text-xl font-medium text-gray-200"><i class="fas fa-lightbulb mr-2"></i> AI Recommendations</h3>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div id="ai-recommendations-content" class="collapsible-content bg-gray-800 p-5 rounded-lg border border-gray-700 mt-2">
                        <div id="care-tips">
                            <p class="text-gray-400">Loading recommendations...</p>
                        </div>
                        <button id="play-alerts-button" class="button-secondary w-full sm:w-auto mt-4">
                            <i class="fas fa-volume-up mr-2"></i> Play Top Alerts
                        </button>
                        <div id="audio-status" class="text-sm text-gray-400 mt-2 text-center"></div>
                    </div>
                </div>

                <!-- Growth Prediction (Collapsible) -->
                <div class="mb-4">
                    <div class="collapsible-header" onclick="toggleCollapsible('growth-prediction-content')">
                        <h3 class="text-xl font-medium text-gray-200"><i class="fas fa-robot mr-2"></i> Growth Prediction</h3>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div id="growth-prediction-content" class="collapsible-content bg-gray-800 p-5 rounded-lg border border-gray-700 mt-2">
                        <div id="growth-prediction">
                            <p class="text-gray-400">Loading predictions...</p>
                        </div>
                    </div>
                </div>

                <!-- Market Forecast (Collapsible) -->
                <div class="mb-4">
                    <div class="collapsible-header" onclick="toggleCollapsible('market-forecast-content')">
                        <h3 class="text-xl font-medium text-gray-200"><i class="fas fa-chart-bar mr-2"></i> Market Forecast</h3>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div id="market-forecast-content" class="collapsible-content bg-gray-800 p-5 rounded-lg border border-gray-700 mt-2">
                        <div id="market-price-forecast">
                            <p class="text-gray-400">Loading forecast...</p>
                        </div>
                    </div>
                </div>

                <!-- Crop Suggestion (Separate, not collapsible in image) -->
                <h3 class="text-xl font-medium text-gray-200 mb-3 mt-6"><i class="fas fa-seedling mr-2"></i> Crop Suggestion Based on Predicted Conditions:</h3>
                <div id="crop-suggestion" class="bg-gray-800 p-5 rounded-lg min-h-[100px] border border-gray-700">
                    <p class="text-gray-400">Loading suggestions...</p>
                </div>

                <!-- New: Pest & Disease Scan -->
                <h3 class="text-xl font-medium text-gray-200 mb-3 mt-6 border-t border-gray-700 pt-4"><i class="fas fa-bug mr-2"></i> Pest & Disease Scan</h3>
                <div id="pest-disease-scan" class="bg-gray-800 p-5 rounded-lg border border-gray-700">
                    <p id="pest-scan-status" class="text-gray-400 mb-4">Last scan: N/A</p>
                    <button id="run-pest-scan-button" class="button-primary w-full">
                        <i class="fas fa-search mr-2"></i> Run New Scan
                    </button>
                    <div id="pest-scan-results" class="mt-4 text-gray-300">
                        <!-- Results will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- Real-Time Plant Monitoring (Middle-Right, Normal) -->
            <div class="card">
                <h2 class="text-2xl font-semibold text-green-300 mb-5 border-b border-gray-700 pb-3">
                    <i class="fas fa-camera mr-2"></i> Real-Time Plant Monitoring
                </h2>
                <div id="camera-feed-container" class="camera-feed-placeholder mb-4">
                    <span class="live-indicator"><i class="fas fa-circle text-red-500 text-xs mr-1"></i> LIVE</span>
                    <span class="connection-status"><i class="fas fa-wifi mr-1"></i> Connected</span>
                    <i class="fas fa-video camera-icon"></i>
                    <p class="text-gray-400 text-lg">Live Camera Feed</p>
                    <p class="text-gray-500 text-sm">Sector A - Field View</p>
                    <span class="camera-overlay-text">Last Frame: N/A</span>
                </div>
                <!-- OUTSIDE the feed box -->
                <div id="camera-details-external" class="camera-details-external text-sm text-gray-300">
                    <span id="camera-resolution">Growth Stage: N/A</span>
                    <span id="camera-fps">Advisory: N/A</span>
                    <span id="camera-signal">Timestamp: N/A</span>
                    <span id="last-frame-time">Last Frame: N/A</span>
                </div>

                <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-4"> <!-- Adjusted for better responsiveness -->
                    <button id="capture-image-button" class="button-primary flex-1">
                        <i class="fas fa-camera-retro mr-2"></i> Capture Image
                    </button>
                    <button id="view-history-button" class="button-secondary flex-1">
                        <i class="fas fa-images mr-2"></i> View History
                    </button>
                </div>
            </div>

            <!-- Recent Events (Bottom-Right, Normal) -->
            <div class="card">
                <h2 class="text-2xl font-semibold text-green-300 mb-5 border-b border-gray-700 pb-3">
                    <i class="fas fa-history mr-2"></i> Recent Events
                </h2>
                <div id="recent-events" class="bg-gray-800 p-5 rounded-lg mb-6 min-h-[150px] border border-gray-700">
                    <p class="text-gray-400">Loading recent events...</p>
                    <!-- Events will be populated here by JS -->
                </div>
                <!-- New: Quick Actions -->
                <h3 class="text-xl font-medium text-gray-200 mb-3 border-t border-gray-700 pt-4"><i class="fas fa-bolt mr-2"></i> Quick Actions</h3>
                <div class="grid grid-cols-1 gap-3">
                    <button class="button-primary w-full"><i class="fas fa-water mr-2"></i> Initiate Irrigation</button>
                    <button class="button-secondary w-full"><i class="fas fa-seedling mr-2"></i> Apply Nutrients</button>
                    <button class="button-primary w-full"><i class="fas fa-bell mr-2"></i> Send Alert</button>
                </div>
            </div>

            <!-- Farm Health Index (Bottom-Left, Tall) -->
            <div class="card xl:row-span-2">
                <h2 class="text-2xl font-semibold text-green-300 mb-5 border-b border-gray-700 pb-3">
                    <i class="fas fa-heartbeat mr-2"></i> Farm Health Index
                </h2>
                <div class="flex flex-col items-center mb-6">
                    <div class="relative w-32 h-32 flex items-center justify-center mb-4">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#4a5568" stroke-width="10"></circle>
                            <circle id="health-score-circle" cx="50" cy="50" r="45" fill="none" stroke="#48bb78" stroke-width="10"
                                stroke-dasharray="0, 282.7" transform="rotate(-90 50 50)"></circle>
                        </svg>
                        <span class="absolute text-4xl font-bold text-white" id="overall-health-score">85</span>
                    </div>
                    <p class="text-green-400 text-xl font-semibold mb-4" id="overall-health-status">Good</p>
                    <div class="w-full">
                        <h3 class="text-lg font-medium text-gray-200 mb-3">Health Factors:</h3>
                        <div class="space-y-3" id="health-factors-list">
                            <!-- Health factors populated by JS -->
                            <div class="flex justify-between items-center text-gray-300">
                                <span>Soil Quality</span>
                                <span class="font-semibold" id="soil-quality-percent">92%</span>
                            </div>
                            <div class="health-factor-progress">
                                <div class="health-factor-bar" id="soil-quality-bar" style="width: 92%;"></div>
                            </div>

                            <div class="flex justify-between items-center text-gray-300">
                                <span>Plant Health</span>
                                <span class="font-semibold" id="plant-health-percent">88%</span>
                            </div>
                            <div class="health-factor-progress">
                                <div class="health-factor-bar" id="plant-health-bar" style="width: 88%;"></div>
                            </div>

                            <div class="flex justify-between items-center text-gray-300">
                                <span>Water Management</span>
                                <span class="font-semibold" id="water-management-percent">78%</span>
                            </div>
                            <div class="health-factor-progress">
                                <div class="health-factor-bar" id="water-management-bar" style="width: 78%;"></div>
                            </div>

                            <div class="flex justify-between items-center text-gray-300">
                                <span>Pest Control</span>
                                <span class="font-semibold" id="pest-control-percent">82%</span>
                            </div>
                            <div class="health-factor-progress">
                                <div class="health-factor-bar" id="pest-control-bar" style="width: 82%;"></div>
                            </div>

                            <div class="flex justify-between items-center text-gray-300">
                                <span>Environmental</span>
                                <span class="font-semibold" id="environmental-percent">90%</span>
                            </div>
                            <div class="health-factor-progress">
                                <div class="health-factor-bar" id="environmental-bar" style="width: 90%;"></div>
                            </div>
                        </div>
                    </div>
                    <p class="text-green-400 text-sm font-semibold mt-4"><i class="fas fa-arrow-up mr-1"></i> <span id="health-change">+5%</span> from last week</p>
                </div>

                <!-- New: Resource Consumption -->
                <h3 class="text-xl font-medium text-gray-200 mb-3 border-t border-gray-700 pt-4"><i class="fas fa-chart-pie mr-2"></i> Resource Consumption (Daily)</h3>
                <div id="resource-consumption" class="space-y-3">
                    <div class="flex justify-between items-center text-gray-300">
                        <span>Water Used:</span>
                        <span class="font-semibold text-blue-300">2500 Liters</span>
                    </div>
                    <div class="flex justify-between items-center text-gray-300">
                        <span>Energy Used:</span>
                        <span class="font-semibold text-yellow-300">50 kWh</span>
                    </div>
                    <div class="flex justify-between items-center text-gray-300">
                        <span>Nutrients Applied:</span>
                        <span class="font-semibold text-green-300">5 kg</span>
                    </div>
                    <button class="button-secondary w-full mt-4"><i class="fas fa-history mr-2"></i> View Usage History</button>
                </div>
            </div>

            <!-- Latest Sensor Readings (Raw Data) (Bottom-Middle, Wide) -->
            <div class="card xl:col-span-2">
                <h2 class="text-2xl font-semibold text-green-300 mb-5 border-b border-gray-700 pb-3">
                    <i class="fas fa-table mr-2"></i> Latest Sensor Readings (Raw Data)
                </h2>
                <div id="raw-data-table" class="dataframe-container mb-6">
                    <p class="text-gray-400 p-4 text-center">Loading raw data...</p>
                </div>
                <!-- New: Data Export -->
                <h3 class="text-xl font-medium text-gray-200 mb-3 border-t border-gray-700 pt-4"><i class="fas fa-download mr-2"></i> Data Export</h3>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button class="button-primary flex-1"><i class="fas fa-file-csv mr-2"></i> Export CSV</button>
                    <button class="button-secondary flex-1"><i class="fas fa-file-excel mr-2"></i> Export Excel</button>
                </div>
            </div>

            <!-- Application Initialization Status (Full Width at bottom) -->
            <div class="card xl:col-span-full">
                <h2 class="text-2xl font-semibold text-green-300 mb-4 cursor-pointer flex justify-between items-center" onclick="toggleExpander('init-status-content')">
                    <span><i class="fas fa-info-circle mr-2"></i> Application Initialization Status</span>
                    <span id="expander-icon" class="float-right transform rotate-0 transition-transform duration-200 text-gray-400">
                        <i class="fas fa-chevron-down"></i>
                    </span>
                </h2>
                <div id="init-status-content" class="hidden">
                    <p class="text-gray-400 p-2 bg-gray-800 rounded-lg border border-gray-700">
                        Backend components (Firebase, AI models, scalers) are initialized during server startup. Check server logs for detailed status.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gray-800 text-gray-400 text-center p-4 mt-auto rounded-t-xl">
        <p>&copy; 2025 Smart AgriTech. All rights reserved.</p>
        <p class="text-sm mt-1">Powered by Advanced AI & Sensor Technology</p>
    </footer>

    <script>
        // Use a relative path for API calls. This assumes your Flask app serves both frontend and backend.
        const API_BASE_URL = 'https://smart-agritech-streamlit-dashbard.onrender.com/api'; // Updated API Base URL

        // Function to create an Audio object and play sound
        function playAudio(audioBlob) {
            const audio = new Audio(URL.createObjectURL(audioBlob));
            audio.play().catch(e => console.error("Error playing audio:", e));
        }

        // Function to update a circular progress bar
        function updateCircularProgress(elementId, value, max_value, unit = '', colorHex = '#48bb78') { // Changed colorClass to colorHex
            const container = document.querySelector(`.circular-progress.${elementId}`);
            const valueSpan = container.querySelector('.progress-value');
            const percent = (value / max_value) * 100;
            const conicGradient = `conic-gradient(${colorHex} ${percent}%, #2d3748 ${percent}%)`; // Use colorHex here

            container.style.background = conicGradient;
            valueSpan.textContent = `${value}${unit}`;
            container.dataset.value = value; // Store value in dataset for reference
        }

        // Function to render sensor trends chart
        function renderSensorTrendsChart(plotData) {
            const chartDiv = document.getElementById('sensor-trends-chart');
            const statusDiv = document.getElementById('sensor-trends-status');

            if (!plotData || plotData.length === 0) {
                statusDiv.textContent = "⚠️ Not enough complete data available for plotting sensor trends. Check if sensors are reporting data for these features.";
                Plotly.purge(chartDiv); // Clear existing chart
                return;
            }
            statusDiv.textContent = ""; // Clear status message

            const traces = [];
            const uniqueMetrics = [...new Set(plotData.map(d => d['Sensor Metric']))];

            // Define a color palette for the lines
            const colors = {
                'Soil Moisture': '#68D391',
                'Temperature': '#F6AD55',
                'Humidity': '#63B3ED',
                'pH': '#A78BFA',
                'Light Intensity': '#ECC94B',
                'N': '#FC8181',
                'P': '#81E6D9',
                'K': '#B794F4',
                'Rainfall': '#4299E1',
                'ds18b20_temperature': '#E53E3E', // A distinct color for the new sensor
                'Growth Factor': '#38A169'
            };

            uniqueMetrics.forEach((metric) => {
                const filteredData = plotData.filter(d => d['Sensor Metric'] === metric);
                traces.push({
                    x: filteredData.map(d => d.timestamp),
                    y: filteredData.map(d => d.Reading),
                    mode: 'lines',
                    name: metric,
                    line: { color: colors[metric] || '#cbd5e0' }, // Assign color from palette, fallback to gray
                    hovertemplate: `<b>%{fullData.name}</b><br>Time: %{x}<br>Reading: %{y:.2f}<extra></extra>`
                });
            });

            const layout = {
                title: {
                    text: "Historical Sensor Readings",
                    font: { color: "#e2e8f0", size: 18 }
                },
                xaxis: {
                    title: "Time",
                    color: "#cbd5e0",
                    gridcolor: '#4a5568',
                    linecolor: '#4a5568',
                    tickfont: { color: "#cbd5e0" }
                },
                yaxis: {
                    title: "Sensor Reading",
                    color: "#cbd5e0",
                    gridcolor: '#4a5568',
                    linecolor: '#4a5568',
                    tickfont: { color: "#cbd5e0" }
                },
                legend: {
                    title: { text: "Metric", font: { color: "#e2e8f0" } },
                    font: { color: "#e2e8f0" },
                    bgcolor: 'rgba(45, 55, 72, 0.7)', // Semi-transparent legend background
                    bordercolor: '#4a5568',
                    borderwidth: 1,
                    x: 1, y: 1, xanchor: 'right', yanchor: 'top' // Position legend
                },
                hovermode: "x unified",
                font: { family: "Inter", size: 12, color: "#e2e8f0" },
                paper_bgcolor: "rgba(0,0,0,0)", // Transparent background for the plot area
                plot_bgcolor: "rgba(0,0,0,0)", // Transparent background for the plot area
                margin: { l: 50, r: 30, t: 70, b: 50 } // Adjust margins
            };

            Plotly.newPlot(chartDiv, traces, layout);
        }

        // Function to populate crop selectbox
        function populateCropSelect(cropLabels) {
            const selectElement = document.getElementById('crop-select');
            selectElement.innerHTML = ''; // Clear existing options

            if (cropLabels && cropLabels.length > 0) {
                cropLabels.forEach(label => {
                    const option = document.createElement('option');
                    option.value = label;
                    option.textContent = label;
                    selectElement.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "No crops found";
                selectElement.appendChild(option);
                selectElement.disabled = true;
            }
        }

        // Function to render raw data table
        function renderRawDataTable(rawData) {
            const tableContainer = document.getElementById('raw-data-table');
            tableContainer.innerHTML = ''; // Clear previous content

            if (!rawData || rawData.length === 0) {
                tableContainer.innerHTML = '<p class="text-gray-400 p-4 text-center">No sensor data to display.</p>';
                return;
            }

            const table = document.createElement('table');
            table.classList.add('min-w-full', 'table-auto'); // Tailwind classes for table styling

            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const headers = Object.keys(rawData[0]); // Get keys from the first object as headers
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase()); // Format header text
                th.classList.add('px-4', 'py-3', 'text-left', 'text-gray-200', 'bg-gray-700', 'font-semibold');
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create table body
            const tbody = document.createElement('tbody');
            rawData.forEach(rowData => {
                const tr = document.createElement('tr');
                tr.classList.add('hover:bg-gray-700', 'transition-colors', 'duration-150');
                headers.forEach(headerText => {
                    const td = document.createElement('td');
                    let value = rowData[headerText];
                    if (typeof value === 'number') {
                        value = value.toFixed(2); // Format numbers
                    }
                    td.textContent = value !== null ? value : 'N/A';
                    td.classList.add('px-4', 'py-2.5', 'border-b', 'border-gray-600', 'text-gray-300');
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            tableContainer.appendChild(table);
        }

        // Function to toggle expander content
        function toggleExpander(contentId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById('expander-icon').querySelector('i');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }

        // Function to toggle collapsible sections
        function toggleCollapsible(contentId) {
            const content = document.getElementById(contentId);
            const header = content.previousElementSibling; // The header is the previous sibling
            const icon = header.querySelector('.fas.fa-chevron-right');

            if (content.classList.contains('active')) {
                content.classList.remove('active');
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('active');
                icon.style.transform = 'rotate(90deg)';
            }
        }


        // Function to display messages with icons
        function displayMessage(elementId, message, type = 'info') {
            const element = typeof elementId === 'string' ? document.getElementById(elementId) : elementId;
            if (!element) return; // Guard against null element

            let iconClass = '';
            let colorClass = 'text-gray-400';

            switch (type) {
                case 'success':
                    iconClass = 'fas fa-check-circle';
                    colorClass = 'text-green-400';
                    break;
                case 'warning':
                    iconClass = 'fas fa-exclamation-triangle';
                    colorClass = 'text-yellow-400';
                    break;
                case 'error':
                    iconClass = 'fas fa-times-circle';
                    colorClass = 'text-red-400';
                    break;
                case 'info':
                default:
                    iconClass = 'fas fa-info-circle';
                    colorClass = 'text-blue-400';
                    break;
            }
            element.innerHTML = `<p class="${colorClass}"><i class="${iconClass} mr-2"></i> ${message}</p>`;
        }

        // Function to render Markdown-like text to HTML
        function renderMarkdown(text) {
            // Replace **text** with <b>text</b>
            let html = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            // Remove any remaining {key:value} placeholders
            html = html.replace(/\{[a-zA-Z_]+(?::[^}]+)?\}/g, '');
            return html;
        }

        // Simulated Weather Data
        function getSimulatedWeatherData() {
            const now = new Date();
            const currentTemp = Math.floor(Math.random() * (30 - 20 + 1)) + 20; // 20-30°C
            const currentHumidity = Math.floor(Math.random() * (80 - 50 + 1)) + 50; // 50-80%
            const windSpeed = Math.floor(Math.random() * (20 - 5 + 1)) + 5; // 5-20 km/h

            const forecast = [
                { day: "Today", high: Math.floor(Math.random() * (35 - 25 + 1)) + 25, low: Math.floor(Math.random() * (20 - 15 + 1)) + 15 },
                { day: "Tomorrow", high: Math.floor(Math.random() * (30 - 20 + 1)) + 20, low: Math.floor(Math.random() * (18 - 12 + 1)) + 12 },
                { day: "Wed", high: Math.floor(Math.random() * (28 - 18 + 1)) + 18, low: Math.floor(Math.random() * (15 - 10 + 1)) + 10 }
            ];

            const advisories = [];
            if (Math.random() < 0.3) { // 30% chance of a warning
                const warnings = ["Heavy Rainfall expected tonight.", "High Wind Advisory issued.", "Frost warning for early morning."];
                advisories.push(`<p class="text-yellow-400"><i class="fas fa-exclamation-triangle text-sm mr-2"></i> ${warnings[Math.floor(Math.random() * warnings.length)]}</p>`);
            }
            if (advisories.length === 0) {
                advisories.push('<p><i class="fas fa-circle-info text-blue-400 text-sm mr-2"></i> No active advisories.</p>');
            }

            return {
                current: {
                    temp: currentTemp,
                    humidity: currentHumidity,
                    wind: windSpeed,
                    timestamp: now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                },
                forecast: forecast,
                advisories: advisories
            };
        }

        // Render Weather Data
        function renderWeatherData() {
            const weather = getSimulatedWeatherData();
            document.getElementById('current-temp').textContent = `${weather.current.temp}°C`;
            document.getElementById('current-humidity').textContent = `${weather.current.humidity}% Humidity`;
            document.getElementById('wind-speed').textContent = `${weather.current.wind} km/h`;

            document.getElementById('today-high').textContent = `${weather.forecast[0].high}°`;
            document.getElementById('today-low').textContent = `${weather.forecast[0].low}°`;
            document.getElementById('tomorrow-high').textContent = `${weather.forecast[1].high}°`;
            document.getElementById('tomorrow-low').textContent = `${weather.forecast[1].low}°`;
            document.getElementById('wed-high').textContent = `${weather.forecast[2].high}°`;
            document.getElementById('wed-low').textContent = `${weather.forecast[2].low}°`;

            document.getElementById('weather-advisories').innerHTML = weather.advisories.join('');
        }

        // Simulated Recent Events Data
        function getSimulatedRecentEvents() {
            const events = [
                { text: "Water detected in sector B", time: "10:27 AM" },
                { text: "Irrigation cycle completed", time: "09:45 AM" },
                { text: "Optimal light conditions detected", time: "09:10 AM" },
                { text: "Nutrient levels adjusted in field 1", time: "Yesterday" },
                { text: "Pest activity observed in north plot", time: "2 days ago" }
            ];
            return events;
        }

        // Render Recent Events
        function renderRecentEvents() {
            const events = getSimulatedRecentEvents();
            const eventsDiv = document.getElementById('recent-events');
            eventsDiv.innerHTML = '';
            if (events.length === 0) {
                eventsDiv.innerHTML = '<p class="text-gray-400">No recent events to display.</p>';
                return;
            }
            events.forEach(event => {
                eventsDiv.innerHTML += `
                    <div class="flex justify-between items-center py-2 border-b border-gray-700 last:border-b-0">
                        <p class="text-gray-300">${event.text}</p>
                        <span class="text-gray-500 text-sm">${event.time}</span>
                    </div>
                `;
            });
        }

        // Simulated Farm Health Index Data
        function getSimulatedFarmHealthData() {
            const overallScore = Math.floor(Math.random() * (95 - 70 + 1)) + 70; // 70-95
            let status = "Good";
            if (overallScore < 75) status = "Fair";
            if (overallScore < 60) status = "Poor";

            const healthFactors = {
                'soil-quality': Math.floor(Math.random() * (98 - 80 + 1)) + 80,
                'plant-health': Math.floor(Math.random() * (95 - 75 + 1)) + 75,
                'water-management': Math.floor(Math.random() * (90 - 70 + 1)) + 70,
                'pest-control': Math.floor(Math.random() * (90 - 70 + 1)) + 70,
                'environmental': Math.floor(Math.random() * (98 - 85 + 1)) + 85
            };

            const healthChange = (Math.random() * 10 - 5).toFixed(0); // -5% to +5%
            const changeIcon = healthChange >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            const changeColor = healthChange >= 0 ? 'text-green-400' : 'text-red-400';

            return {
                overallScore,
                status,
                healthFactors,
                healthChange,
                changeIcon,
                changeColor
            };
        }

        // Render Farm Health Index
        function renderFarmHealthIndex() {
            const healthData = getSimulatedFarmHealthData();

            // Overall Score
            document.getElementById('overall-health-score').textContent = healthData.overallScore;
            document.getElementById('overall-health-status').textContent = healthData.status;
            const healthCircle = document.getElementById('health-score-circle');
            const circumference = 2 * Math.PI * 45; // 2 * pi * r, r=45
            const progress = (healthData.overallScore / 100) * circumference;
            healthCircle.style.strokeDasharray = `${progress}, ${circumference}`;
            healthCircle.style.stroke = healthData.overallScore >= 75 ? '#48bb78' : (healthData.overallScore >= 60 ? '#F6AD55' : '#E53E3E');


            // Health Factors
            for (const factor in healthData.healthFactors) {
                const percent = healthData.healthFactors[factor];
                const percentElement = document.getElementById(`${factor}-percent`);
                const barElement = document.getElementById(`${factor}-bar`);
                if (percentElement) percentElement.textContent = `${percent}%`;
                if (barElement) barElement.style.width = `${percent}%`;
            }

            // Health Change
            const healthChangeElement = document.getElementById('health-change');
            healthChangeElement.textContent = `${healthData.healthChange >= 0 ? '+' : ''}${healthData.healthChange}%`;
            healthChangeElement.className = `${healthData.changeColor} text-sm font-semibold mt-4`; // Reapply classes
            healthChangeElement.previousElementSibling.className = `fas ${healthData.changeIcon} mr-1`; // Update icon
        }

        // Simulated Device Connectivity Data
        function getSimulatedDeviceConnectivity() {
            const statuses = ['Online', 'Offline', 'Active', 'Inactive', 'Connected', 'Disconnected'];
            const getRandomStatus = () => statuses[Math.floor(Math.random() * statuses.length)];

            return {
                gateway: Math.random() < 0.9 ? 'Online' : 'Offline',
                irrigation: Math.random() < 0.8 ? 'Active' : 'Inactive',
                camera: `${Math.floor(Math.random() * 4)}/3 Connected`, // Simulate some cameras being offline
                soil: Math.random() < 0.95 ? 'All Online' : 'Some Offline'
            };
        }

        // Render Device Connectivity
        function renderDeviceConnectivity() {
            const connectivity = getSimulatedDeviceConnectivity();

            const updateStatus = (id, statusText) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = statusText;
                    element.className = 'font-semibold ' + (statusText.includes('Online') || statusText.includes('Active') || statusText.includes('Connected') ? 'text-green-400' : 'text-red-400');
                    element.innerHTML = `<i class="fas fa-circle text-xs mr-1"></i> ${statusText}`;
                }
            };

            updateStatus('gateway-status', connectivity.gateway);
            updateStatus('irrigation-status', connectivity.irrigation);
            updateStatus('camera-status', connectivity.camera);
            updateStatus('soil-sensor-status', connectivity.soil);
        }

        // Simulated Pest Scan Data
        function getSimulatedPestScanResults() {
            const results = [
                { status: 'No threats detected. Your crops are healthy!', type: 'success' },
                { status: 'Minor pest activity detected in Sector C. Recommend localized treatment.', type: 'warning', details: ['Aphids (low concentration)'] },
                { status: 'Disease detected in Field 2. Immediate action required.', type: 'error', details: ['Fungal blight (moderate)'] }
            ];
            return results[Math.floor(Math.random() * results.length)];
        }

        // Simulate a pest scan
        async function runPestScan() {
            const scanButton = document.getElementById('run-pest-scan-button');
            const scanStatus = document.getElementById('pest-scan-status');
            const scanResultsDiv = document.getElementById('pest-scan-results');

            scanButton.disabled = true;
            scanButton.innerHTML = '<span class="loading-spinner"></span> Scanning...';
            scanStatus.textContent = 'Scanning in progress...';
            scanResultsDiv.innerHTML = '';

            await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate API call delay

            const result = getSimulatedPestScanResults();
            scanStatus.textContent = `Last scan: ${new Date().toLocaleTimeString()}`;

            let resultHtml = `<p class="mb-2"><i class="fas ${result.type === 'success' ? 'fa-check-circle text-green-400' : result.type === 'warning' ? 'fa-exclamation-triangle text-yellow-400' : 'fa-times-circle text-red-400'} mr-2"></i> ${result.status}</p>`;

            if (result.details && result.details.length > 0) {
                resultHtml += '<p class="font-semibold mt-3">Details:</p><ul class="list-disc list-inside ml-4">';
                result.details.forEach(detail => {
                    resultHtml += `<li>${detail}</li>`;
                });
                resultHtml += '</ul>';
            }
            scanResultsDiv.innerHTML = resultHtml;

            scanButton.disabled = false;
            scanButton.innerHTML = '<i class="fas fa-search mr-2"></i> Run New Scan';
        }

        // Main data fetching and rendering function
        async function fetchDataAndRender() {
            document.getElementById('refresh-button').disabled = true;
            document.getElementById('refresh-button').innerHTML = '<span class="loading-spinner"></span> Loading...';

            try {
                const response = await fetch(`${API_BASE_URL}/data`);
                const data = await response.json();

                if (data.status === 'no_data') {
                    // Update circular progress bars with 0 and N/A
                    updateCircularProgress('soil-moisture', 0, 100, '%', '#68D391');
                    document.getElementById('soil-moisture-update').textContent = "Updated: N/A";
                    updateCircularProgress('temperature', 0, 40, '°C', '#F6AD55');
                    document.getElementById('temperature-update').textContent = "Updated: N/A";
                    updateCircularProgress('humidity', 0, 100, '%', '#63B3ED');
                    document.getElementById('humidity-update').textContent = "Updated: N/A";
                    updateCircularProgress('ph', 0, 14, '', '#A78BFA');
                    document.getElementById('ph-update').textContent = "Updated: N/A";
                    updateCircularProgress('light-intensity', 0, 1000, ' lux', '#ECC94B'); // Assuming max light intensity 1000 lux
                    document.getElementById('light-intensity-update').textContent = "Updated: N/A";
                    updateCircularProgress('rainfall', 0, 250, ' mm', '#4299E1'); // Assuming max rainfall 250 mm
                    document.getElementById('rainfall-update').textContent = "Updated: N/A";

                    displayMessage('sensor-trends-status', "⚠️ Not enough complete data available for plotting sensor trends. Check if sensors are reporting data for these features.", 'warning');
                    Plotly.purge('sensor-trends-chart');
                    // Keep camera feed placeholder as is, it has its own dummy logic
                    renderRawDataTable([]);
                    displayMessage('care-tips', "No sensor data available for crop care recommendations.", 'info');
                    displayMessage('growth-prediction', "Select a crop, ensure sensor data is available, and all AI components are loaded for prediction.", 'info');
                    displayMessage('market-price-forecast', "Select a crop, ensure sensor data is available, and market model is trained for market price forecast.", 'info');
                    displayMessage('crop-suggestion', "Predicted soil moisture is out of typical range or not available, hindering specific crop suggestions.", 'info');
                    populateCropSelect(data.crop_labels); // Still populate crop labels if available
                    return;
                }

                const latestData = data.latest_data;
                const plotData = data.plot_data;
                const cameraData = data.camera_data;
                const rawData = data.raw_data;
                const cropLabels = data.crop_labels;

                // Render Custom Circular Gauges
                const formattedTimestamp = new Date(latestData.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                updateCircularProgress('soil-moisture', latestData.soil_moisture || 0, 100, '%', '#68D391');
                document.getElementById('soil-moisture-update').textContent = `Updated: ${formattedTimestamp}`;
                updateCircularProgress('temperature', latestData.temperature || 0, 40, '°C', '#F6AD55');
                document.getElementById('temperature-update').textContent = `Updated: ${formattedTimestamp}`;
                updateCircularProgress('humidity', latestData.humidity || 0, 100, '%', '#63B3ED');
                document.getElementById('humidity-update').textContent = `Updated: ${formattedTimestamp}`;
                updateCircularProgress('ph', latestData.ph || 0, 14, '', '#A78BFA');
                document.getElementById('ph-update').textContent = `Updated: ${formattedTimestamp}`;
                updateCircularProgress('light-intensity', latestData.light_intensity || 0, 1000, ' lux', '#ECC94B'); // Assuming max light intensity 1000 lux
                document.getElementById('light-intensity-update').textContent = `Updated: ${formattedTimestamp}`;
                updateCircularProgress('rainfall', latestData.rainfall || 0, 250, ' mm', '#4299E1'); // Assuming max rainfall 250 mm
                document.getElementById('rainfall-update').textContent = `Updated: ${formattedTimestamp}`;


                // Render Sensor Trends Chart
                renderSensorTrendsChart(plotData);

                // Populate Crop Select and trigger initial predictions/advice
                populateCropSelect(cropLabels);
                // Trigger change event to load initial data for selected crop
                const cropSelect = document.getElementById('crop-select');
                if (cropSelect.value) {
                    cropSelect.dispatchEvent(new Event('change'));
                } else {
                    displayMessage('care-tips', "Please select a crop to get recommendations.", 'info');
                    displayMessage('growth-prediction', "Select a crop, ensure sensor data is available, and all AI components are loaded for prediction.", 'info');
                    displayMessage('market-price-forecast', "Select a crop, ensure sensor data is available, and market model is trained for market price forecast.", 'info');
                    displayMessage('crop-suggestion', "Predicted soil moisture is out of typical range or not available, hindering specific crop suggestions.", 'info');
                }

                // Display Camera Feed Data (using the placeholder structure)
                const cameraFeedContainer = document.getElementById('camera-feed-container');
                // Target the new external camera details container
                const cameraDetailsExternal = document.getElementById('camera-details-external');

                if (cameraData) {
                    // Update connection status based on actual data presence
                    const connectionStatusSpan = cameraFeedContainer.querySelector('.connection-status');
                    connectionStatusSpan.innerHTML = '<i class="fas fa-wifi mr-1"></i> Connected';
                    connectionStatusSpan.style.backgroundColor = '#48bb78'; // Green

                    // Update details in the EXTERNAL container
                    cameraDetailsExternal.querySelector('#camera-resolution').textContent = `Growth Stage: ${cameraData.stage || 'N/A'}`;
                    cameraDetailsExternal.querySelector('#camera-fps').textContent = `Advisory: ${cameraData.alert || 'N/A'}`;
                    cameraDetailsExternal.querySelector('#camera-signal').textContent = `Timestamp: ${new Date(cameraData.timestamp).toLocaleTimeString() || 'N/A'}`;
                    cameraDetailsExternal.querySelector('#last-frame-time').textContent = `Last Frame: ${new Date(cameraData.timestamp).toLocaleTimeString() || 'N/A'}`;

                } else {
                    const connectionStatusSpan = cameraFeedContainer.querySelector('.connection-status');
                    connectionStatusSpan.innerHTML = '<i class="fas fa-wifi-slash mr-1"></i> Disconnected';
                    connectionStatusSpan.style.backgroundColor = '#e53e3e'; // Red

                    // Reset details in the EXTERNAL container
                    cameraDetailsExternal.querySelector('#camera-resolution').textContent = `No Camera Data`;
                    cameraDetailsExternal.querySelector('#camera-fps').textContent = `N/A`;
                    cameraDetailsExternal.querySelector('#camera-signal').textContent = `N/A`;
                    cameraDetailsExternal.querySelector('#last-frame-time').textContent = `Last Frame: N/A`;
                }

                // Render Raw Data Table
                renderRawDataTable(rawData);

                // Render Weather Data
                renderWeatherData();

                // Render Recent Events
                renderRecentEvents();

                // Render Farm Health Index
                renderFarmHealthIndex();

                // Render Device Connectivity
                renderDeviceConnectivity();

            } catch (error) {
                console.error("Error fetching dashboard data:", error);
                // Display error messages on relevant sections
                displayMessage('soil-moisture-update', "Error loading data", 'error');
                displayMessage('temperature-update', "Error loading data", 'error');
                displayMessage('humidity-update', "Error loading data", 'error');
                displayMessage('ph-update', "Error loading data", 'error');
                displayMessage('light-intensity-update', "Error loading data", 'error');
                displayMessage('rainfall-update', "Error loading data", 'error');
                displayMessage('sensor-trends-status', "Error loading sensor trends.", 'error');
                displayMessage('raw-data-table', "Error loading raw data.", 'error');
                displayMessage('care-tips', "Error loading recommendations.", 'error');
                displayMessage('growth-prediction', "Error loading predictions.", 'error');
                displayMessage('market-price-forecast', "Error loading forecast.", 'error');
                displayMessage('crop-suggestion', "Error loading suggestions.", 'error');
            } finally {
                document.getElementById('refresh-button').disabled = false;
                document.getElementById('refresh-button').innerHTML = '<i class="fas fa-sync-alt mr-2"></i> Refresh Data';
            }
        }

        // Function to get the currently selected language from Google Translate dropdown
        function getSelectedGoogleTranslateLanguage() {
            const combo = document.querySelector('.goog-te-combo');
            return combo ? combo.value : 'en'; // Default to 'en' if not found
        }

        // Function to update predictions and advice based on selected crop
        async function updateCropSpecificData() {
            const selectedCropType = document.getElementById('crop-select').value;
            // Get language from Google Translate dropdown - used for TTS, not for backend messages
            const currentLang = getSelectedGoogleTranslateLanguage();

            if (!selectedCropType) {
                displayMessage('care-tips', "Please select a crop to get recommendations.", 'info');
                displayMessage('growth-prediction', "Select a crop, ensure sensor data is available, and all AI components are loaded for prediction.", 'info');
                displayMessage('market-price-forecast', "Select a crop, ensure sensor data is available, and market model is trained for market price forecast.", 'info');
                displayMessage('crop-suggestion', "Predicted soil moisture is out of typical range or not available, hindering specific crop suggestions.", 'info');
                return;
            }

            // Fetch Crop Care Recommendations
            try {
                const response = await fetch(`${API_BASE_URL}/care_advice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selected_crop_type: selectedCropType, lang: currentLang })
                });
                const data = await response.json();
                const careTipsDiv = document.getElementById('care-tips');
                if (data.advice && data.advice.length > 0) {
                    careTipsDiv.innerHTML = data.advice.map(tip => `<p class="mb-2 last:mb-0">${renderMarkdown(tip)}</p>`).join('');
                } else {
                    displayMessage('care-tips', "No specific care recommendations available.", 'info');
                }
            } catch (error) {
                console.error("Error fetching crop care advice:", error);
                displayMessage('care-tips', "Error loading crop care recommendations.", 'error');
            }

            let predictedSoilMoisture = null;

            // Fetch AI-Based Growth Prediction
            try {
                const response = await fetch(`${API_BASE_URL}/predict_growth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selected_crop_type: selectedCropType })
                });
                const data = await response.json();
                const growthPredictionDiv = document.getElementById('growth-prediction');
                if (data.error) {
                    displayMessage('growth-prediction', `Error: ${data.error}`, 'error');
                } else {
                    predictedSoilMoisture = data.soil_moisture_pred;
                    let soilMoistureMsg = `📊 Predicted Soil Moisture: <b>${data.soil_moisture_pred.toFixed(2)}%</b>`;
                    if (!(0 <= data.soil_moisture_pred && data.soil_moisture_pred <= 100)) { // Corrected logical AND
                        soilMoistureMsg += `. This value seems unusual (Expected between 0-100%).`;
                        growthPredictionDiv.innerHTML = `<p class="text-yellow-400"><i class="fas fa-exclamation-triangle mr-2"></i> ${soilMoistureMsg}</p>`;
                    } else {
                        growthPredictionDiv.innerHTML = `<p class="text-green-400"><i class="fas fa-check-circle mr-2"></i> ${soilMoistureMsg}</p>`;
                    }
                    growthPredictionDiv.innerHTML += `<p class="text-blue-400 mt-2"><i class="fas fa-sun mr-2"></i> Predicted Light Intensity: <b>${data.light_intensity_pred.toFixed(2)} lux</b></p>`;
                    growthPredictionDiv.innerHTML += `<p class="text-green-400 mt-2"><i class="fas fa-flask mr-2"></i> Predicted NPK Nutrient Sum: <b>${data.nutrient_sum_pred.toFixed(2)}</b></p>`;
                }
            } catch (error) {
                console.error("Error fetching growth prediction:", error);
                displayMessage('growth-prediction', "Error loading AI-based growth prediction.", 'error');
            }

            // Fetch Market Price Forecast
            try {
                const response = await fetch(`${API_BASE_URL}/market_price`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selected_crop_type: selectedCropType })
                });
                const data = await response.json();
                const marketPriceDiv = document.getElementById('market-price-forecast');
                if (data.error) {
                    displayMessage('market-price-forecast', `Error: ${data.error}`, 'error');
                } else {
                    marketPriceDiv.innerHTML = `<p class="text-green-400"><i class="fas fa-money-bill-wave mr-2"></i> Estimated Market Price for ${selectedCropType}: <b>₹ ${data.predicted_price.toFixed(2)} / unit</b></p>`;
                }
            } catch (error) {
                console.error("Error fetching market price forecast:", error);
                displayMessage('market-price-forecast', "Error loading market price forecast.", 'error');
            }

            // Fetch Crop Suggestion Based on Predicted Conditions
            try {
                const response = await fetch(`${API_BASE_URL}/seed_recommendations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ soil_moisture_pred: predictedSoilMoisture, lang: currentLang })
                });
                const data = await response.json();
                const cropSuggestionDiv = document.getElementById('crop-suggestion');
                if (data.error) {
                    displayMessage('crop-suggestion', `Error: ${data.error}`, 'error');
                } else {
                    cropSuggestionDiv.innerHTML = `<p class="text-gray-300">${renderMarkdown(data.recommendation)}</p>`;
                }
            } catch (error) {
                console.error("Error fetching crop suggestion:", error);
                displayMessage('crop-suggestion', "Error loading crop suggestions.", 'error');
            }
        }

        // Event Listeners
        document.getElementById('refresh-button').addEventListener('click', fetchDataAndRender);
        document.getElementById('crop-select').addEventListener('change', updateCropSpecificData);
        document.getElementById('run-pest-scan-button').addEventListener('click', runPestScan);


        document.getElementById('play-alerts-button').addEventListener('click', async () => {
            const careTipsDiv = document.getElementById('care-tips');
            const audioStatusDiv = document.getElementById('audio-status');
            const currentLang = getSelectedGoogleTranslateLanguage();

            const tips = Array.from(careTipsDiv.querySelectorAll('p')).map(p => p.textContent);

            if (tips.length === 0 || tips[0].includes("No specific care recommendations") || tips[0].includes("Loading recommendations...")) {
                audioStatusDiv.textContent = "ℹ️ No specific alerts to play.";
                return;
            }

            audioStatusDiv.textContent = "🔊 Playing alerts...";
            const topAlerts = tips.slice(0, 2); // Play up to 2 alerts

            for (let i = 0; i < topAlerts.length; i++) {
                let tip = topAlerts[i];
                // Remove markdown and emojis for better speech
                const cleanTip = tip.replace(/\*\*/g, '').replace(/[🌱🌡️💨🧪☀️🌧️✅⚠️❌ℹ️]/g, '').trim();
                if (cleanTip) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/voice_alert`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text: cleanTip, lang: currentLang })
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`Server error: ${response.status} ${response.statusText} - ${errorText}`);
                        }

                        const audioBlob = await response.blob();
                        playAudio(audioBlob);
                        audioStatusDiv.textContent = `🔊 Playing alert ${i + 1}: "${cleanTip}"`;
                        // Wait for the audio to finish or a reasonable duration
                        await new Promise(resolve => setTimeout(resolve, cleanTip.length * 50 + 1000)); // Rough estimate
                    } catch (error) {
                        console.error("Error playing voice alert:", error);
                        audioStatusDiv.textContent = `❌ Error playing alert ${i + 1}: ${error.message}`;
                        break; // Stop playing if an error occurs
                    }
                }
            }
            audioStatusDiv.textContent = "🔊 Alerts finished.";
        });

        // Function to set the simulation mode via API
        async function setSimulationMode(isSimulation) {
            const mode = isSimulation ? 'simulation' : 'real-time';
            try {
                const response = await fetch(`${API_BASE_URL}/set_mode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: mode })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    console.log(`Backend mode set to: ${data.mode}`);
                    // Optionally, re-fetch data to reflect the mode change immediately
                    fetchDataAndRender();
                } else {
                    console.error("Failed to set backend mode:", data.message);
                }
            } catch (error) {
                console.error("Error setting simulation mode:", error);
            }
        }

        // Function to get the current simulation mode from API and update toggle
        async function getAndSetInitialMode() {
            try {
                const response = await fetch(`${API_BASE_URL}/get_mode`);
                const data = await response.json();
                const toggle = document.getElementById('simulation-mode-toggle');
                if (data.mode === 'simulation') {
                    toggle.checked = true; // Set to simulation (right side)
                } else {
                    toggle.checked = false; // Set to real-time (left side)
                }
                console.log(`Initial backend mode: ${data.mode}`);
            } catch (error) {
                console.error("Error fetching initial simulation mode:", error);
            }
        }

        // Google Translate Widget Initialization - Moved to global scope
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'en,hi,bn,ta,te,ml,gu,mr,kn,pa,ur,es,fr,de,ar,ja', // Added English explicitly and more languages
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE
            }, 'google_translate_element');
        }

        // Initial data load when the page is ready
        document.addEventListener('DOMContentLoaded', () => {
            getAndSetInitialMode(); // Get initial mode and set toggle state
            fetchDataAndRender();
            // Set up auto-refresh (e.g., every 30 seconds)
            setInterval(fetchDataAndRender, 30000); // Refresh every 30 seconds

            // Add event listener for the toggle switch
            document.getElementById('simulation-mode-toggle').addEventListener('change', (event) => {
                setSimulationMode(event.target.checked);
            });

            // Load Google Translate script
            const googleTranslateScript = document.createElement('script');
            googleTranslateScript.type = 'text/javascript';
            googleTranslateScript.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
            document.body.appendChild(googleTranslateScript);

            // Auto-Detect and Switch Language
            // This needs to run AFTER the Google Translate widget is fully loaded and initialized.
            setTimeout(() => {
                const userLang = navigator.language || navigator.userLanguage;
                const combo = document.querySelector('.goog-te-combo');
                const langMatch = {
                    'en': 'en', 'hi': 'hi', 'bn': 'bn', 'ta': 'ta', 'te': 'te', 'ml': 'ml',
                    'gu': 'gu', 'mr': 'mr', 'kn': 'kn', 'pa': 'pa', 'ur': 'ur',
                    'es': 'es', 'fr': 'fr', 'de': 'de', 'ar': 'ar', 'ja': 'ja'
                };

                const shortLang = userLang.split('-')[0];
                if (langMatch[shortLang]) {
                    if (combo && combo.querySelector(`option[value="${langMatch[shortLang]}"]`)) {
                        combo.value = langMatch[shortLang];
                        // Trigger change event to apply translation immediately
                        combo.dispatchEvent(new Event('change'));
                        // Also trigger our dashboard's update function after translation
                        updateCropSpecificData();
                    }
                }
            }, 1500); // Increased timeout slightly to ensure Google Translate loads
        });
    </script>
</body>
</html>
